<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anajak T-Shirt - DTG Price Calculator v11.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .form-select, .form-input { transition: all 0.2s ease-in-out; }
        .form-select:focus, .form-input:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); border-color: #3b82f6; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .tab-content, .mode-view { display: none; }
        .tab-content.active, .mode-view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-backdrop.visible { display: flex; opacity: 1; }
        .modal-content {
            transform: scale(0.95); opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); opacity: 1; }
        .spinner { border-top-color: transparent; width: 1.25rem; height: 1.25rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .selection-item { cursor: pointer; }
        .selection-item:hover { background-color: #f1f5f9; }
        .calculation-group, .mode-view { animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .mode-button {
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
        }
        .mode-button.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="w-full max-w-5xl mx-auto my-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ DTG</h1>
            <p class="text-slate-500 mt-1">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô Anajak T-Shirt</p>
            <p class="text-xs text-slate-400 mt-2">v11.1</p>
            <div id="admin-access-container" class="mt-4 h-10 flex justify-center items-center"></div>
        </header>

        <main class="w-full bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Tabs Navigation -->
            <div class="border-b border-slate-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button class="tab-button w-1/3 py-4 px-1 text-center border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700 hover:border-slate-300 transition-colors" data-tab="calculator-tab">
                        üßÆ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                    </button>
                    <button class="tab-button w-1/3 py-4 px-1 text-center border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700 hover:border-slate-300 transition-colors" data-tab="products-tab" id="products-tab-button">
                        üëï ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)
                    </button>
                    <button class="tab-button w-1/3 py-4 px-1 text-center border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700 hover:border-slate-300 transition-colors" data-tab="settings-tab" id="settings-tab-button">
                        ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏ï‡∏£
                    </button>
                </nav>
            </div>

            <!-- Tabs Content -->
            <div class="p-6 sm:p-8">
                <!-- Calculator Tab -->
                <div id="calculator-tab" class="tab-content">
                    <!-- Mode Selector -->
                    <div class="flex justify-center border-b border-slate-200 mb-6">
                        <div class="flex space-x-8">
                             <button id="mode-screen-only-btn" data-mode="screen-only" class="mode-button py-3 px-1 text-slate-600">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô</button>
                             <button id="mode-shirt-screen-btn" data-mode="shirt-screen" class="mode-button py-3 px-1 text-slate-600">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏Å‡∏£‡∏µ‡∏ô</button>
                        </div>
                    </div>

                    <!-- Mode View: Screen Only -->
                    <div id="screen-only-mode-view" class="mode-view">
                        <form id="screen-only-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <div>
                                    <label for="so-quantity" class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ï‡∏±‡∏ß)</label>
                                    <input type="number" id="so-quantity" name="quantity" class="form-input w-full p-3 bg-slate-50 border-slate-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50" required>
                                </div>
                                <div>
                                    <label for="so-inkCC" class="block text-sm font-medium text-slate-700 mb-1">CC ‡∏´‡∏°‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏£‡∏ß‡∏°)</label>
                                    <input type="number" id="so-inkCC" name="inkCC" class="form-input w-full p-3 bg-slate-50 border-slate-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5" required>
                                </div>
                                <div>
                                    <label for="so-color" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠</label>
                                    <select id="so-color" name="color" class="form-select w-full p-3 bg-slate-50 border-slate-300 rounded-lg">
                                        <option value="black">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°/‡∏î‡∏≥</option>
                                        <option value="white">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="so-sides" class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏Å‡∏£‡∏µ‡∏ô</label>
                                    <select id="so-sides" name="sides" class="form-select w-full p-3 bg-slate-50 border-slate-300 rounded-lg">
                                        <option value="1">1 ‡∏î‡πâ‡∏≤‡∏ô</option>
                                        <option value="2">2 ‡∏î‡πâ‡∏≤‡∏ô (‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á)</option>
                                    </select>
                                </div>
                                <div id="so-side-choice-container">
                                    <label for="so-sideChoice" class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô</label>
                                    <select id="so-sideChoice" name="sideChoice" class="form-select w-full p-3 bg-slate-50 border-slate-300 rounded-lg">
                                        <option value="front">‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option>
                                        <option value="back">‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á</option>
                                    </select>
                                </div>
                                <div id="so-size-front-container">
                                    <label for="so-sizeFront" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤</label>
                                    <select id="so-sizeFront" name="sizeFront" class="form-select w-full p-3 bg-slate-50 border-slate-300 rounded-lg">
                                        <option value="A7">A7</option><option value="A6">A6</option><option value="A5">A5</option><option value="A4" selected>A4</option><option value="A3">A3</option><option value="A2">A2</option>
                                    </select>
                                </div>
                                <div id="so-size-back-container" class="hidden">
                                    <label for="so-sizeBack" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
                                    <select id="so-sizeBack" name="sizeBack" class="form-select w-full p-3 bg-slate-50 border-slate-300 rounded-lg">
                                        <option value="A7">A7</option><option value="A6">A6</option><option value="A5">A5</option><option value="A4" selected>A4</option><option value="A3">A3</option><option value="A2">A2</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2 border-t pt-4 mt-2">
                                    <h3 class="text-md font-medium text-slate-800 mb-4">‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏° (Add-ons)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-center">
                                        <div class="relative flex items-start">
                                            <div class="flex h-6 items-center"> <input id="so-neckLogo" name="neckLogo" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-600"> </div>
                                            <div class="ml-3 text-sm leading-6"> <label for="so-neckLogo" class="font-medium text-slate-700">‡∏™‡∏Å‡∏£‡∏µ‡∏ô Logo ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠</label> </div>
                                        </div>
                                        <div>
                                            <label for="so-sleevePrintCount" class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÅ‡∏Ç‡∏ô</label>
                                            <input type="number" id="so-sleevePrintCount" name="sleevePrintCount" class="form-input w-full p-3 bg-slate-50 border-slate-300 rounded-lg" value="0" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8"> <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô</button> </div>
                        </form>
                        <div id="screen-only-result-container" class="hidden mt-8">
                            <div class="bg-slate-50 p-6 rounded-lg">
                                <h2 class="text-xl font-bold text-slate-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô)</h2>
                                <div id="so-result-summary" class="space-y-4 text-slate-700"></div>
                                <div id="so-result-details" class="mt-6 pt-4 border-t border-slate-200 text-xs text-slate-500 space-y-2"></div>
                                <button id="copy-screen-only-button" class="mt-6 w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                            </div>
                        </div>
                    </div>

                    <!-- Mode View: Shirt + Screen -->
                    <div id="shirt-and-screen-mode-view" class="mode-view">
                        <div id="calculation-groups-container" class="space-y-8">
                            <p id="empty-calculator-message" class="text-center text-slate-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì<br>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
                        </div>
                        <div class="mt-8 pt-6 border-t border-dashed">
                            <button type="button" id="add-new-group-btn" class="w-full bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 transition-colors">
                                + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </div>
                        <div id="calculation-actions" class="hidden mt-8">
                            <button id="calculate-all-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        </div>
                        <div id="grouped-result-container" class="hidden mt-8">
                            <div class="bg-slate-50 p-6 rounded-lg">
                                <h2 class="text-xl font-bold text-slate-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏Å‡∏£‡∏µ‡∏ô)</h2>
                                <div id="result-summary" class="space-y-6 text-slate-700"></div>
                                <div class="mt-6 pt-4 border-t border-slate-300">
                                    <h3 class="font-bold text-lg text-slate-800">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                                    <div id="grand-total-summary" class="mt-2"></div>
                                </div>
                                <div id="result-details-container" class="mt-6 pt-4 border-t border-slate-200 text-xs text-slate-500 space-y-4"></div>
                                <button id="copy-grouped-button" class="mt-6 w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Management Tab -->
                <div id="products-tab" class="tab-content">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                        <h2 class="text-xl font-bold text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</h2>
                        <div>
                            <input type="file" id="excel-import-input" class="hidden" accept=".xlsx, .xls">
                            <button id="excel-import-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ Excel</button>
                        </div>
                    </div>
                    <form id="product-form" class="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-4">
                        <input type="hidden" id="product-id">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="sm:col-span-2">
                                    <label for="product-name" class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏∑‡πâ‡∏≠ (‡∏£‡∏∏‡πà‡∏ô)</label>
                                    <input type="text" id="product-name" class="form-input w-full p-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô Anajak Oversize" required>
                                </div>
                                <div>
                                    <label for="product-sku-code" class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏´‡∏±‡∏™ (SKU)</label>
                                    <input type="text" id="product-sku-code" class="form-input w-full p-2" placeholder="S011-W-L" required>
                                </div>
                            <div>
                                <label for="product-size-input" class="block text-sm font-medium text-slate-700 mb-1">‡πÑ‡∏ã‡∏™‡πå</label>
                                <input type="text" id="product-size-input" class="form-input w-full p-2" placeholder="L" required>
                            </div>
                           <div>
                                <label for="product-color-input" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏µ</label>
                                <input type="text" id="product-color-input" class="form-input w-full p-2" placeholder="‡∏Ç‡∏≤‡∏ß" required>
                            </div>
                           <div>
                                    <label for="product-cost-price" class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</label>
                                    <input type="number" id="product-cost-price" class="form-input w-full p-2" placeholder="72" required>
                                </div>
                                <div class="sm:col-span-3">
                                    <label for="product-sell-price" class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label>
                                    <input type="number" id="product-sell-price" class="form-input w-full p-2" placeholder="140" required>
                                </div>
                                <div class="sm:col-span-3 flex items-end h-full">
                                    <button type="submit" id="save-product-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                                </div>
                        </div>
                         <button type="button" id="cancel-edit-product-button" class="w-full mt-2 bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </form>
                    <div id="product-list" class="mt-6 space-y-6">
                        <!-- Product list will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô)</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                        <!-- Settings fields will be populated by JavaScript -->
                    </div>
                     <div class="mt-6 flex justify-center"> <button id="save-settings-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button> </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="delete-modal" class="modal-backdrop items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
            <h3 class="text-lg font-bold text-slate-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <p class="text-sm text-slate-600 my-4">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö <strong id="item-name-to-delete"></strong>? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-button" class="flex-1 bg-slate-200 text-slate-800 py-2 px-4 rounded-lg hover:bg-slate-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-delete-button" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
            </div>
        </div>
    </div>
    
    <div id="import-status-modal" class="modal-backdrop items-center justify-center p-4">
        <div id="import-status-content" class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full p-6 text-center"></div>
    </div>

    <div id="password-modal" class="modal-backdrop items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold text-slate-800 text-center">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
            <p class="text-sm text-slate-600 my-2 text-center">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</p>
            <input type="password" id="password-input" class="form-input w-full p-2 mt-4 border-slate-300 rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <p id="password-error" class="text-red-500 text-xs mt-1 h-4"></p>
            <div class="flex justify-center gap-4 mt-4">
                <button id="cancel-password-button" class="flex-1 bg-slate-200 text-slate-800 py-2 px-4 rounded-lg hover:bg-slate-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="submit-password-button" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="product-selection-modal" class="modal-backdrop items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <div id="selection-steps-container" class="min-h-[300px]">
                    <!-- Step 1: Select Model Name -->
                    <div id="selection-step-1">
                        <h4 class="text-md font-semibold text-slate-700 mb-2">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏™‡∏∑‡πâ‡∏≠</h4>
                        <div id="product-name-list" class="space-y-1 max-h-64 overflow-y-auto"></div>
                    </div>
                    <!-- Step 2: Select Size -->
                    <div id="selection-step-2" class="hidden">
                        <h4 class="text-md font-semibold text-slate-700 mb-2">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong id="selected-model-name-display"></strong></h4>
                        <div id="product-size-list" class="space-y-1 max-h-64 overflow-y-auto"></div>
                         <button type="button" class="back-to-step-1 mt-4 text-sm text-slate-600 hover:underline"> &larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô</button>
                    </div>
                    <!-- Step 3: Select Color -->
                    <div id="selection-step-3" class="hidden">
                        <h4 class="text-md font-semibold text-slate-700 mb-2">3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong id="selected-size-display"></strong></h4>
                        <div id="product-color-list" class="space-y-1 max-h-64 overflow-y-auto"></div>
                         <button type="button" class="back-to-step-2 mt-4 text-sm text-slate-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå</button>
                    </div>
                </div>
            </div>
            <div id="add-to-cart-section" class="hidden p-4 bg-slate-100 border-t">
                <p class="font-medium text-slate-800 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <strong id="final-product-display"></strong></p>
                <div class="flex items-center gap-4">
                    <label for="add-quantity" class="text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                    <input type="number" id="add-quantity" value="1" min="1" class="form-input w-20 p-2 text-center">
                    <button id="confirm-add-item-btn" class="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end">
                <button id="cancel-selection-button" class="bg-slate-200 text-slate-800 py-2 px-4 rounded-lg hover:bg-slate-300">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, addDoc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBeCIQ8rsmm_-lMGTjekKo3OS82sK7rBrs",
            authDomain: "dtg-calculate.firebaseapp.com",
            projectId: "dtg-calculate",
            storageBucket: "dtg-calculate.appspot.com",
            messagingSenderId: "495910696434",
            appId: "1:495910696434:web:4a47c8e05f777ff07b676b",
            measurementId: "G-KTL2EEQJDM"
        };
        
        // --- App Initialization ---
        let app, db;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); } catch (e) { console.error("Firebase initialization failed:", e); }
        
        const DOMElements = {
            adminAccessContainer: document.getElementById('admin-access-container'),
            tabs: document.querySelectorAll('.tab-button'),
            contents: document.querySelectorAll('.tab-content'),
            calculator: {
                modeShirtScreenBtn: document.getElementById('mode-shirt-screen-btn'),
                modeScreenOnlyBtn: document.getElementById('mode-screen-only-btn'),
                shirtScreenView: document.getElementById('shirt-and-screen-mode-view'),
                screenOnlyView: document.getElementById('screen-only-mode-view'),
                // Grouped mode elements
                groupsContainer: document.getElementById('calculation-groups-container'),
                addNewGroupBtn: document.getElementById('add-new-group-btn'),
                emptyMessage: document.getElementById('empty-calculator-message'),
                actionsContainer: document.getElementById('calculation-actions'),
                calculateAllBtn: document.getElementById('calculate-all-btn'),
                groupedResultContainer: document.getElementById('grouped-result-container'),
                resultSummary: document.getElementById('result-summary'),
                grandTotalSummary: document.getElementById('grand-total-summary'),
                resultDetailsContainer: document.getElementById('result-details-container'),
                copyGroupedButton: document.getElementById('copy-grouped-button'),
                // Screen-only mode elements
                screenOnlyForm: document.getElementById('screen-only-form'),
                soResultContainer: document.getElementById('screen-only-result-container'),
                soResultSummary: document.getElementById('so-result-summary'),
                soResultDetails: document.getElementById('so-result-details'),
                copyScreenOnlyButton: document.getElementById('copy-screen-only-button'),
                soSidesSelect: document.getElementById('so-sides'),
                soSideChoiceContainer: document.getElementById('so-side-choice-container'),
                soSizeFrontContainer: document.getElementById('so-size-front-container'),
                soSizeBackContainer: document.getElementById('so-size-back-container'),
            },
            products: {
                form: document.getElementById('product-form'),
                list: document.getElementById('product-list'),
                idInput: document.getElementById('product-id'),
                nameInput: document.getElementById('product-name'),
                skuCodeInput: document.getElementById('product-sku-code'),
                sizeInput: document.getElementById('product-size-input'),
                colorInput: document.getElementById('product-color-input'),
                costPriceInput: document.getElementById('product-cost-price'),
                sellPriceInput: document.getElementById('product-sell-price'),
                saveButton: document.getElementById('save-product-button'),
                cancelButton: document.getElementById('cancel-edit-product-button'),
                tabButton: document.getElementById('products-tab-button'),
                importButton: document.getElementById('excel-import-button'),
                importInput: document.getElementById('excel-import-input'),
            },
            settings: {
                container: document.querySelector('#settings-tab .grid'),
                saveButton: document.getElementById('save-settings-button'),
                tabButton: document.getElementById('settings-tab-button'),
                fields: {},
            },
            deleteModal: {
                backdrop: document.getElementById('delete-modal'),
                itemNameToDelete: document.getElementById('item-name-to-delete'),
                cancelButton: document.getElementById('cancel-delete-button'),
                confirmButton: document.getElementById('confirm-delete-button'),
                itemIdToDelete: null,
                deleteType: null, // 'product' or 'group'
            },
            importStatusModal: {
                backdrop: document.getElementById('import-status-modal'),
                content: document.getElementById('import-status-content'),
            },
            passwordModal: {
                backdrop: document.getElementById('password-modal'),
                input: document.getElementById('password-input'),
                error: document.getElementById('password-error'),
                cancelButton: document.getElementById('cancel-password-button'),
                submitButton: document.getElementById('submit-password-button'),
            },
            productSelectionModal: {
                backdrop: document.getElementById('product-selection-modal'),
                step1: document.getElementById('selection-step-1'),
                step2: document.getElementById('selection-step-2'),
                step3: document.getElementById('selection-step-3'),
                nameList: document.getElementById('product-name-list'),
                sizeList: document.getElementById('product-size-list'),
                colorList: document.getElementById('product-color-list'),
                modelNameDisplay: document.getElementById('selected-model-name-display'),
                sizeDisplay: document.getElementById('selected-size-display'),
                backToStep1Btn: document.querySelector('.back-to-step-1'),
                backToStep2Btn: document.querySelector('.back-to-step-2'),
                cancelBtn: document.getElementById('cancel-selection-button'),
                addToCartSection: document.getElementById('add-to-cart-section'),
                finalProductDisplay: document.getElementById('final-product-display'),
                quantityInput: document.getElementById('add-quantity'),
                confirmAddBtn: document.getElementById('confirm-add-item-btn'),
            }
        };

        let currentSettings = {};
        let productsData = []; 
        let calculationGroups = [];
        let isAuthorized = false;
        let targetTabId = null;
        let currentMode = 'screen-only'; // 'shirt-screen' or 'screen-only'
        const ADMIN_PASSWORD = '!Bestlxk007';
        let currentSelection = { name: null, size: null, color: null, product: null };
        let currentTargetGroupId = null;

        const DEFAULT_CONFIG = {
            INK_COST_PER_CC: 16, PRETREAT_1_SIDE: 40, PRETREAT_2_SIDES: 70, NECK_LOGO_COST: 30, SLEEVE_PRINT_COST: 70,
            WHITE_TSHIRT_DISCOUNT: 40, PROFIT_MARGIN: 1.30, MIN_SELL_PRICE: 100, WHITE_TSHIRT_PRICE_CAP: 300,
            DISCOUNT_TIERS: [ { qty: 100, rate: 0.15 }, { qty: 50, rate: 0.10 }, { qty: 30, rate: 0.05 }, ],
        };
        const SETTING_DEFINITIONS = {
            INK_COST_PER_CC: "‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏´‡∏°‡∏∂‡∏Å/CC", PRETREAT_1_SIDE: "‡∏£‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô 1 ‡∏î‡πâ‡∏≤‡∏ô", PRETREAT_2_SIDES: "‡∏£‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô 2 ‡∏î‡πâ‡∏≤‡∏ô",
            NECK_LOGO_COST: "‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ñ‡∏≠", SLEEVE_PRINT_COST: "‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÅ‡∏Ç‡∏ô (‡∏ï‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)", WHITE_TSHIRT_DISCOUNT: "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏ß",
            PROFIT_MARGIN: "‡∏Å‡∏≥‡πÑ‡∏£ (‡πÄ‡∏ä‡πà‡∏ô 1.3)", MIN_SELL_PRICE: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥", WHITE_TSHIRT_PRICE_CAP: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏ß",
        };

        // --- Admin Access & Password Functions ---
        const updateAdminAccessUI = () => {
            if (isAuthorized) {
                DOMElements.adminAccessContainer.innerHTML = `<div class="flex items-center space-x-3"><span class="text-sm text-green-600 font-medium">üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß</span><button id="lock-system-button" class="text-sm text-slate-500 hover:underline">‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏∞‡∏ö‡∏ö</button></div>`;
                document.getElementById('lock-system-button').addEventListener('click', lockSystem);
            } else { DOMElements.adminAccessContainer.innerHTML = ''; }
        };
        const lockSystem = () => { isAuthorized = false; updateAdminAccessUI(); switchTab('calculator-tab'); };
        const openPasswordModal = (tabId) => {
            targetTabId = tabId;
            DOMElements.passwordModal.backdrop.classList.add('visible');
            DOMElements.passwordModal.input.focus();
        };
        const closePasswordModal = () => { DOMElements.passwordModal.backdrop.classList.remove('visible'); targetTabId = null; };
        const handlePasswordSubmit = () => {
            if (DOMElements.passwordModal.input.value === ADMIN_PASSWORD) {
                isAuthorized = true;
                updateAdminAccessUI();
                if (targetTabId) { switchTab(targetTabId); }
                closePasswordModal();
            } else { DOMElements.passwordModal.error.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
        };
        const handleProtectedTabClick = (tabId) => { if (isAuthorized) { switchTab(tabId); } else { openPasswordModal(tabId); } };

        // --- Calculation Group Functions (Shirt + Screen Mode) ---
        const addNewCalculationGroup = () => {
            const newGroup = {
                id: `group-${Date.now()}`,
                name: `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì #${calculationGroups.length + 1}`,
                items: [],
                screenDetails: { color: 'black', inkCC: 5, sides: '1', sideChoice: 'front', sizeFront: 'A4', sizeBack: 'A4', neckLogo: false, sleevePrintCount: 0, }
            };
            calculationGroups.push(newGroup);
            renderCalculationGroups();
        };

        const renderCalculationGroups = () => {
            const container = DOMElements.calculator.groupsContainer;
            container.innerHTML = '';

            if (calculationGroups.length === 0) {
                DOMElements.calculator.emptyMessage.classList.remove('hidden');
                DOMElements.calculator.actionsContainer.classList.add('hidden');
                DOMElements.calculator.groupedResultContainer.classList.add('hidden');
            } else {
                DOMElements.calculator.emptyMessage.classList.add('hidden');
                DOMElements.calculator.actionsContainer.classList.remove('hidden');
                calculationGroups.forEach(group => {
                    const groupEl = createGroupElement(group);
                    container.appendChild(groupEl);
                    renderGroupItems(group);
                });
            }
        };
        
        const createGroupElement = (group) => {
            const div = document.createElement('div');
            div.className = 'calculation-group bg-slate-50 border border-slate-200 rounded-xl p-4 md:p-6';
            div.id = group.id;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b border-slate-200 pb-4">
                    <input type="text" value="${group.name}" data-group-id="${group.id}" class="group-name-input text-lg font-semibold text-slate-800 bg-transparent border-none focus:ring-2 focus:ring-blue-300 rounded-md p-1 -m-1 w-full" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ...">
                    <button type="button" class="remove-group-btn text-red-500 hover:text-red-700 font-bold p-2 ml-4" data-group-id="${group.id}" data-group-name="${group.name}">&times; ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</button>
                </div>
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-md font-medium text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <button type="button" data-group-id="${group.id}" class="add-item-to-group-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                    </div>
                    <div id="calculation-items-list-${group.id}" class="space-y-2 bg-white p-4 rounded-lg min-h-[60px]">
                        <p class="empty-group-message text-center text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</p>
                    </div>
                </div>
                <div class="border-t pt-6">
                    <h3 class="text-md font-medium text-slate-800 mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏Å‡∏£‡∏µ‡∏ô</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <label for="color-${group.id}" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô)</label>
                            <select id="color-${group.id}" data-group-id="${group.id}" class="group-input form-select w-full p-3 bg-white border-slate-300 rounded-lg">
                                <option value="black" ${group.screenDetails.color === 'black' ? 'selected' : ''}>‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°/‡∏î‡∏≥</option>
                                <option value="white" ${group.screenDetails.color === 'white' ? 'selected' : ''}>‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß</option>
                            </select>
                        </div>
                        <div>
                            <label for="inkCC-${group.id}" class="block text-sm font-medium text-slate-700 mb-1">CC ‡∏´‡∏°‡∏∂‡∏Å</label>
                            <input type="number" id="inkCC-${group.id}" data-group-id="${group.id}" value="${group.screenDetails.inkCC}" class="group-input form-input w-full p-3 bg-white border-slate-300 rounded-lg" required>
                        </div>
                        <div>
                            <label for="sides-${group.id}" class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô</label>
                            <select id="sides-${group.id}" data-group-id="${group.id}" class="group-input group-sides-select form-select w-full p-3 bg-white border-slate-300 rounded-lg">
                                <option value="1" ${group.screenDetails.sides === '1' ? 'selected' : ''}>1 ‡∏î‡πâ‡∏≤‡∏ô</option>
                                <option value="2" ${group.screenDetails.sides === '2' ? 'selected' : ''}>2 ‡∏î‡πâ‡∏≤‡∏ô</option>
                            </select>
                        </div>
                        <div id="side-choice-container-${group.id}">
                            <label for="sideChoice-${group.id}" class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô</label>
                            <select id="sideChoice-${group.id}" data-group-id="${group.id}" class="group-input group-side-choice-select form-select w-full p-3 bg-white border-slate-300 rounded-lg">
                                <option value="front" ${group.screenDetails.sideChoice === 'front' ? 'selected' : ''}>‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option>
                                <option value="back" ${group.screenDetails.sideChoice === 'back' ? 'selected' : ''}>‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á</option>
                            </select>
                        </div>
                        <div id="size-front-container-${group.id}">
                            <label for="sizeFront-${group.id}" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤</label>
                            <select id="sizeFront-${group.id}" data-group-id="${group.id}" class="group-input form-select w-full p-3 bg-white border-slate-300 rounded-lg">
                                ${['A7','A6','A5','A4','A3','A2'].map(s => `<option value="${s}" ${group.screenDetails.sizeFront === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div id="size-back-container-${group.id}">
                            <label for="sizeBack-${group.id}" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏á</label>
                            <select id="sizeBack-${group.id}" data-group-id="${group.id}" class="group-input form-select w-full p-3 bg-white border-slate-300 rounded-lg">
                                ${['A7','A6','A5','A4','A3','A2'].map(s => `<option value="${s}" ${group.screenDetails.sizeBack === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t border-slate-200">
                    <h3 class="text-md font-medium text-slate-800 mb-4">‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-center">
                            <div class="relative flex items-start">
                                <div class="flex h-6 items-center"> <input id="neckLogo-${group.id}" data-group-id="${group.id}" type="checkbox" class="group-input h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-600" ${group.screenDetails.neckLogo ? 'checked' : ''}> </div>
                                <div class="ml-3 text-sm leading-6"> <label for="neckLogo-${group.id}" class="font-medium text-slate-700">‡∏™‡∏Å‡∏£‡∏µ‡∏ô Logo ‡∏Ñ‡∏≠</label> </div>
                            </div>
                            <div>
                                <label for="sleevePrintCount-${group.id}" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÅ‡∏Ç‡∏ô (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)</label>
                                <input type="number" id="sleevePrintCount-${group.id}" data-group-id="${group.id}" value="${group.screenDetails.sleevePrintCount}" class="group-input form-input w-full p-3 bg-white border-slate-300 rounded-lg" value="0" min="0">
                            </div>
                       </div>
                </div>
            `;
            updateGroupFormUI(div, group);
            return div;
        };

        const renderGroupItems = (group) => {
            const itemsList = document.getElementById(`calculation-items-list-${group.id}`);
            const emptyMessage = itemsList.querySelector('.empty-group-message');
            itemsList.querySelectorAll('.item-row').forEach(el => el.remove());

            if (group.items.length === 0) {
                emptyMessage.classList.remove('hidden');
            } else {
                emptyMessage.classList.add('hidden');
                group.items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'item-row bg-slate-50 p-3 rounded-md border flex items-center justify-between gap-4';
                    div.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-medium text-slate-800">${item.product.name}</p>
                            <p class="text-sm text-slate-500">${item.product.size} - ${item.product.color}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="qty-${item.id}" class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                            <input type="number" id="qty-${item.id}" value="${item.quantity}" min="1" class="form-input w-20 p-1 text-center quantity-input" data-group-id="${group.id}" data-item-index="${index}">
                        </div>
                        <button type="button" class="remove-item-btn text-red-500 hover:text-red-700" data-group-id="${group.id}" data-item-index="${index}">&times;</button>
                    `;
                    itemsList.appendChild(div);
                });
            }
        };
        
        const updateGroupState = (groupId, key, value) => {
            const group = calculationGroups.find(g => g.id === groupId);
            if (!group) return;

            if (key === 'name') {
                group.name = value;
            } else if (key === 'itemQuantity') {
                const { itemIndex, quantity } = value;
                group.items[itemIndex].quantity = quantity;
            } else {
                group.screenDetails[key] = value;
            }
        };
        
        const updateGroupFormUI = (groupEl, group) => {
            const sides = group.screenDetails.sides;
            const sideChoice = group.screenDetails.sideChoice;
            const isOneSide = (sides === '1');

            groupEl.querySelector(`#side-choice-container-${group.id}`).style.display = isOneSide ? 'block' : 'none';
            if (isOneSide) {
                groupEl.querySelector(`#size-front-container-${group.id}`).style.display = (sideChoice === 'front') ? 'block' : 'none';
                groupEl.querySelector(`#size-back-container-${group.id}`).style.display = (sideChoice === 'back') ? 'block' : 'none';
            } else {
                groupEl.querySelector(`#size-front-container-${group.id}`).style.display = 'block';
                groupEl.querySelector(`#size-back-container-${group.id}`).style.display = 'block';
            }
        };

        // --- Product Selection Modal Functions ---
        const openProductSelectionModal = (groupId) => {
            currentTargetGroupId = groupId;
            currentSelection = { name: null, size: null, color: null, product: null };
            DOMElements.productSelectionModal.addToCartSection.classList.add('hidden');
            populateSelectionStep1();
            DOMElements.productSelectionModal.backdrop.classList.add('visible');
        };
        const closeProductSelectionModal = () => {
            DOMElements.productSelectionModal.backdrop.classList.remove('visible');
            currentTargetGroupId = null;
        };
        const showSelectionStep = (step) => {
            DOMElements.productSelectionModal.step1.classList.toggle('hidden', step !== 1);
            DOMElements.productSelectionModal.step2.classList.toggle('hidden', step !== 2);
            DOMElements.productSelectionModal.step3.classList.toggle('hidden', step !== 3);
            DOMElements.productSelectionModal.addToCartSection.classList.add('hidden');
        };
        const createSelectionItem = (text, dataKey, dataValue) => {
            const item = document.createElement('div');
            item.className = 'selection-item p-3 rounded-md border';
            item.textContent = text;
            item.dataset[dataKey] = dataValue;
            return item;
        };
        const populateSelectionStep1 = () => {
            const names = [...new Set(productsData.map(p => p.name))].sort();
            const { nameList } = DOMElements.productSelectionModal;
            nameList.innerHTML = '';
            if (names.length === 0) {
                nameList.innerHTML = '<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô</p>';
            } else {
                names.forEach(name => nameList.appendChild(createSelectionItem(name, 'name', name)));
            }
            showSelectionStep(1);
        };
        const populateSelectionStep2 = () => {
            const sizes = [...new Set(productsData.filter(p => p.name === currentSelection.name).map(p => p.size))].sort();
            const { sizeList, modelNameDisplay } = DOMElements.productSelectionModal;
            sizeList.innerHTML = '';
            modelNameDisplay.textContent = currentSelection.name;
            sizes.forEach(size => sizeList.appendChild(createSelectionItem(size, 'size', size)));
            showSelectionStep(2);
        };
        const populateSelectionStep3 = () => {
            const colors = productsData.filter(p => p.name === currentSelection.name && p.size === currentSelection.size);
            const { colorList, sizeDisplay } = DOMElements.productSelectionModal;
            colorList.innerHTML = '';
            sizeDisplay.textContent = `${currentSelection.name} (${currentSelection.size})`;
            colors.forEach(product => colorList.appendChild(createSelectionItem(product.color, 'color', product.color)));
            showSelectionStep(3);
        };
        const handleProductSelection = (e) => {
            const target = e.target.closest('.selection-item');
            if (!target) return;

            const { step1, step2, step3 } = DOMElements.productSelectionModal;
            if (step1.contains(target)) {
                currentSelection.name = target.dataset.name;
                populateSelectionStep2();
            } else if (step2.contains(target)) {
                currentSelection.size = target.dataset.size;
                populateSelectionStep3();
            } else if (step3.contains(target)) {
                currentSelection.color = target.dataset.color;
                currentSelection.product = productsData.find(p => p.name === currentSelection.name && p.size === currentSelection.size && p.color === currentSelection.color);
                if (currentSelection.product) {
                    DOMElements.productSelectionModal.finalProductDisplay.textContent = `${currentSelection.product.name} - ${currentSelection.product.size} (${currentSelection.product.color})`;
                    DOMElements.productSelectionModal.addToCartSection.classList.remove('hidden');
                    DOMElements.productSelectionModal.quantityInput.focus();
                }
            }
        };
        const addItemToCalculationGroup = () => {
            if (!currentSelection.product || !currentTargetGroupId) return;
            const group = calculationGroups.find(g => g.id === currentTargetGroupId);
            if (!group) return;

            const quantity = parseInt(DOMElements.productSelectionModal.quantityInput.value) || 1;
            group.items.push({ product: currentSelection.product, quantity: quantity, id: `item-${Date.now()}` });
            renderGroupItems(group);
            closeProductSelectionModal();
        };

        // --- Settings Functions ---
        const createSettingsFields = () => {
            DOMElements.settings.container.innerHTML = '';
            for (const key in SETTING_DEFINITIONS) {
                const labelText = SETTING_DEFINITIONS[key];
                const value = currentSettings[key] ?? DEFAULT_CONFIG[key];
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `<label for="setting-${key}" class="block mb-1 font-medium text-slate-700">${labelText}</label><input type="number" step="${key === 'PROFIT_MARGIN' ? '0.01' : '1'}" id="setting-${key}" class="form-input w-full p-2 bg-slate-50 border-slate-300 rounded-lg" value="${value}">`;
                DOMElements.settings.container.appendChild(wrapper);
                DOMElements.settings.fields[key] = wrapper.querySelector('input');
            }
        };
        const loadGlobalSettings = async () => {
            const settingsDocRef = doc(db, "app_config", "main_settings");
            try {
                const docSnap = await getDoc(settingsDocRef);
                currentSettings = { ...DEFAULT_CONFIG, ...(docSnap.exists() ? docSnap.data() : {}) };
            } catch (e) { console.error("Error loading global settings:", e); currentSettings = { ...DEFAULT_CONFIG }; }
            createSettingsFields();
        };
        const saveGlobalSettings = async () => {
            if (!isAuthorized) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            const newSettings = {};
            for(const key in DOMElements.settings.fields) { newSettings[key] = parseFloat(DOMElements.settings.fields[key].value) || DEFAULT_CONFIG[key]; }
            try {
                await setDoc(doc(db, "app_config", "main_settings"), newSettings);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                currentSettings = newSettings;
            } catch (e) { console.error("Error saving settings:", e); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!"); }
        };

        // --- Product Functions ---
        const renderProductList = (products) => {
            productsData = products.sort((a, b) => a.name.localeCompare(b.name) || a.sku.localeCompare(b.sku));
            const groupedProducts = productsData.reduce((acc, p) => {
                if (!acc[p.name]) acc[p.name] = [];
                acc[p.name].push(p);
                return acc;
            }, {});

            DOMElements.products.list.innerHTML = productsData.length > 0 ? '' : '<p class="text-center text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
            Object.keys(groupedProducts).sort().forEach(groupName => {
                const groupWrapper = document.createElement('div');
                groupWrapper.innerHTML = `<h3 class="text-lg font-semibold text-slate-700 mb-2 border-b pb-2">${groupName}</h3>`;
                const groupList = document.createElement('div');
                groupList.className = 'space-y-2';
                groupedProducts[groupName].forEach(p => {
                    const pEl = document.createElement('div');
                    pEl.className = "bg-slate-50 p-3 rounded-lg flex justify-between items-center border border-slate-200";
                    pEl.innerHTML = `<div><p class="font-medium text-slate-800">[${p.sku}] ${p.size} - ${p.color}</p><p class="text-sm text-slate-500">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${p.costPrice} ‡∏ö. / ‡∏Ç‡∏≤‡∏¢: ${p.sellPrice} ‡∏ö.</p></div><div class="space-x-2"><button class="edit-product-btn p-2 text-slate-500 hover:text-blue-600" data-id="${p.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="delete-product-btn p-2 text-slate-500 hover:text-red-600" data-id="${p.id}" data-name="${p.name} ${p.size} ${p.color}">‡∏•‡∏ö</button></div>`;
                    groupList.appendChild(pEl);
                });
                groupWrapper.appendChild(groupList);
                DOMElements.products.list.appendChild(groupWrapper);
            });
        };
        const handleSaveProduct = async (e) => {
            e.preventDefault();
            if (!isAuthorized) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            const data = {
                name: DOMElements.products.nameInput.value.trim(),
                sku: DOMElements.products.skuCodeInput.value.trim(),
                size: DOMElements.products.sizeInput.value.trim(),
                color: DOMElements.products.colorInput.value.trim(),
                costPrice: parseFloat(DOMElements.products.costPriceInput.value),
                sellPrice: parseFloat(DOMElements.products.sellPriceInput.value),
            };
            const id = DOMElements.products.idInput.value;
            if (!data.name || !data.sku || !data.size || !data.color || isNaN(data.costPrice) || isNaN(data.sellPrice)) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            try {
                if (id) { await updateDoc(doc(db, "products", id), data); } 
                else { await addDoc(collection(db, "products"), data); }
                resetProductForm();
            } catch (error) { console.error("Error saving product:", error); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"); }
        };
        const resetProductForm = () => {
            DOMElements.products.form.reset();
            DOMElements.products.idInput.value = '';
            DOMElements.products.saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            DOMElements.products.cancelButton.classList.add('hidden');
        };
        const handleEditProductClick = (e) => {
            if (!e.target.classList.contains('edit-product-btn')) return;
            const productId = e.target.dataset.id;
            const productData = productsData.find(p => p.id === productId);
            if (!productData) return;
            DOMElements.products.idInput.value = productData.id;
            DOMElements.products.nameInput.value = productData.name;
            DOMElements.products.skuCodeInput.value = productData.sku;
            DOMElements.products.sizeInput.value = productData.size;
            DOMElements.products.colorInput.value = productData.color;
            DOMElements.products.costPriceInput.value = productData.costPrice;
            DOMElements.products.sellPriceInput.value = productData.sellPrice;
            DOMElements.products.saveButton.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            DOMElements.products.cancelButton.classList.remove('hidden');
            window.scrollTo(0,0);
            DOMElements.products.nameInput.focus();
        };
        const handleDeleteProduct = async (id) => {
            if (!isAuthorized) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö");
            try { await deleteDoc(doc(db, "products", id)); } 
            catch (error) { console.error("Error deleting product:", error); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö"); }
        };
        const openDeleteModal = (options) => {
            const { type, id, name } = options;
            DOMElements.deleteModal.deleteType = type;
            DOMElements.deleteModal.itemIdToDelete = id;
            DOMElements.deleteModal.itemNameToDelete.textContent = name;
            DOMElements.deleteModal.backdrop.classList.add('visible');
        };
        const closeDeleteModal = () => { DOMElements.deleteModal.backdrop.classList.remove('visible'); };
        const handleExcelImport = (event) => {
            if (!isAuthorized) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                showImportStatusModal('<div class="spinner border-4 border-slate-200 border-t-blue-600 rounded-full mx-auto"></div><p class="mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå Excel...</p>');
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    if (json.length === 0) throw new Error("‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    const batch = writeBatch(db);
                    let importedCount = 0;
                    json.forEach(row => {
                        const sku = row['‡∏£‡∏´‡∏±‡∏™']?.toString().trim();
                        const name = row['‡πÄ‡∏™‡∏∑‡πâ‡∏≠']?.toString().trim();
                        const size = row['‡πÑ‡∏ã‡∏™‡πå']?.toString().trim();
                        const color = row['‡∏™‡∏µ']?.toString().trim();
                        const sellPrice = parseFloat(row['‡∏£‡∏≤‡∏Ñ‡∏≤']);
                        const costPrice = parseFloat(row['‡∏ó‡∏∏‡∏ô']);
                        if (sku && name && size && color && !isNaN(sellPrice) && !isNaN(costPrice)) {
                            const docRef = doc(collection(db, "products"));
                            batch.set(docRef, { sku, name, size, color, sellPrice, costPrice });
                            importedCount++;
                        }
                    });
                    if (importedCount === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel");
                    await batch.commit();
                    showImportStatusModal(`<h3 class="text-lg font-bold text-green-600">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3><p class="my-4">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${importedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p><button id="close-import-modal" class="bg-blue-600 text-white py-2 px-4 rounded-lg">‡∏õ‡∏¥‡∏î</button>`);
                    document.getElementById('close-import-modal').addEventListener('click', closeImportStatusModal);
                } catch (error) {
                    console.error("Excel import error:", error);
                    showImportStatusModal(`<h3 class="text-lg font-bold text-red-600">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</h3><p class="my-4">${error.message}</p><button id="close-import-modal" class="bg-blue-600 text-white py-2 px-4 rounded-lg">‡∏õ‡∏¥‡∏î</button>`);
                    document.getElementById('close-import-modal').addEventListener('click', closeImportStatusModal);
                } finally { event.target.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        };
        const showImportStatusModal = (htmlContent) => { DOMElements.importStatusModal.content.innerHTML = htmlContent; DOMElements.importStatusModal.backdrop.classList.add('visible'); };
        const closeImportStatusModal = () => { DOMElements.importStatusModal.backdrop.classList.remove('visible'); };

        // --- Calculation Functions ---
        const calculateScreenPrice = (inputs) => {
            const { color, sides, inkCC, quantity, hasNeckLogo, sleevePrintCount, sizeFront, sizeBack, sideChoice } = inputs;
            const details = [];
            
            const pretreatCost = (sides === '1') ? currentSettings.PRETREAT_1_SIDE : currentSettings.PRETREAT_2_SIDES;
            const neckLogoCost = hasNeckLogo ? currentSettings.NECK_LOGO_COST : 0;
            const sleeveCost = sleevePrintCount * currentSettings.SLEEVE_PRINT_COST;
            const rawScreenCost = (inkCC * currentSettings.INK_COST_PER_CC) + pretreatCost + neckLogoCost + sleeveCost;
            let addonsDetail = [];
            if(hasNeckLogo) addonsDetail.push(`‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ñ‡∏≠ ${neckLogoCost}`);
            if(sleevePrintCount > 0) addonsDetail.push(`‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÅ‡∏Ç‡∏ô ${sleeveCost}`);
            const addonsString = addonsDetail.length > 0 ? ` + ${addonsDetail.join(' + ')}` : '';
            details.push(`‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏Å‡∏£‡∏µ‡∏ô: (‡∏´‡∏°‡∏∂‡∏Å ${inkCC}cc * ${currentSettings.INK_COST_PER_CC}) + ‡∏£‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô ${pretreatCost}${addonsString} = ${rawScreenCost.toFixed(2)} ‡∏ö.`);
            const costAfter15 = rawScreenCost * 0.85;
            details.push(`‡∏´‡∏±‡∏Å 15%: ${costAfter15.toFixed(2)} ‡∏ö.`);
            const finalScreenCost = Math.ceil(costAfter15 / 10) * 10;
            details.push(`‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö ‚áí <strong>${finalScreenCost}</strong> ‡∏ö.`);
            let sellRaw = finalScreenCost * currentSettings.PROFIT_MARGIN;
            details.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡∏î‡∏¥‡∏ö: ${finalScreenCost} * ${currentSettings.PROFIT_MARGIN} = ${sellRaw.toFixed(2)} ‡∏ö.`);

            if (color === 'white') {
                sellRaw -= currentSettings.WHITE_TSHIRT_DISCOUNT;
                details.push(`‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏ß ‡∏•‡∏î ${currentSettings.WHITE_TSHIRT_DISCOUNT} ‡∏ö. ‚áí ${sellRaw.toFixed(2)} ‡∏ö.`);
            }

            let priceBeforeDiscount = Math.ceil(sellRaw / 10) * 10;
            details.push(`‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö ‚áí ${priceBeforeDiscount} ‡∏ö.`);

            if (color === 'white') {
                if (priceBeforeDiscount > currentSettings.WHITE_TSHIRT_PRICE_CAP) {
                    priceBeforeDiscount = currentSettings.WHITE_TSHIRT_PRICE_CAP;
                    details.push(`<span class="text-amber-600">‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${currentSettings.WHITE_TSHIRT_PRICE_CAP} ‡∏ö.</span>`);
                }
                
                // --- NEW WHITE SHIRT MINIMUM PRICE LOGIC ---
                const sizeOrder = { 'A7': 1, 'A6': 2, 'A5': 3, 'A4': 4, 'A3': 5, 'A2': 6 };
                const getWhiteShirtPriceBySize = (size, type = 'min') => {
                    const smallSizes = ['A7', 'A6', 'A5'];
                    const mediumSizes = ['A4', 'A3'];
                    if (type === 'min') {
                        if (smallSizes.includes(size)) return 100;
                        if (mediumSizes.includes(size)) return 150;
                        if (size === 'A2') return 180;
                    } else if (type === 'add') {
                        if (smallSizes.includes(size)) return 50;
                        if (mediumSizes.includes(size)) return 80;
                        if (size === 'A2') return 100;
                    }
                    return 0;
                };

                let newMinPrice = 0;
                let minPriceDetail = '';

                if (sides === '1') {
                    const printSize = sideChoice === 'front' ? sizeFront : sizeBack;
                    newMinPrice = getWhiteShirtPriceBySize(printSize, 'min');
                    minPriceDetail = `(‡∏Ç‡∏ô‡∏≤‡∏î ${printSize})`;
                } else { // sides === '2'
                    let largerSize, smallerSize;
                    if (sizeOrder[sizeFront] >= sizeOrder[sizeBack]) {
                        largerSize = sizeFront;
                        smallerSize = sizeBack;
                    } else {
                        largerSize = sizeBack;
                        smallerSize = sizeFront;
                    }
                    const priceSide1 = getWhiteShirtPriceBySize(largerSize, 'min');
                    const priceSide2 = getWhiteShirtPriceBySize(smallerSize, 'add');
                    newMinPrice = priceSide1 + priceSide2;
                    minPriceDetail = `(‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ${largerSize} + ‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡πá‡∏Å ${smallerSize})`;
                }
                
                details.push(`‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏ß ${minPriceDetail}: ${newMinPrice} ‡∏ö.`);

                if (priceBeforeDiscount < newMinPrice) {
                    priceBeforeDiscount = newMinPrice;
                    details.push(`<span class="text-red-600">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏Å‡∏£‡∏µ‡∏ô ‚áí ${priceBeforeDiscount} ‡∏ö.</span>`);
                }
                // --- END NEW LOGIC ---

            } else { // Dark shirts use the original global minimum price
                if (priceBeforeDiscount < currentSettings.MIN_SELL_PRICE) {
                    priceBeforeDiscount = currentSettings.MIN_SELL_PRICE;
                    details.push(`<span class="text-red-600">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${currentSettings.MIN_SELL_PRICE} ‡∏ö.</span>`);
                }
            }

            const discountTier = currentSettings.DISCOUNT_TIERS.find(t => quantity >= t.qty);
            const discountRate = discountTier ? discountTier.rate : 0;
            const screenPriceAfterDiscount = priceBeforeDiscount * (1 - discountRate);
            let discountText = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô';
            if (discountRate > 0) {
                discountText = `‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ${discountRate * 100}% (‡∏™‡∏±‡πà‡∏á ${quantity} ‡∏ï‡∏±‡∏ß)`;
                details.push(`‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${discountText}`);
            }
            return { screenPricePerItem: screenPriceAfterDiscount, details, discountText };
        };

        const handleShirtAndScreenCalculate = () => {
            let allGroupsValid = true;
            calculationGroups.forEach(group => {
                if (group.screenDetails.inkCC <= 0) {
                    alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å 'CC ‡∏´‡∏°‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ' ‡πÉ‡∏ô '${group.name}' ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                    allGroupsValid = false;
                }
                if (group.items.length === 0) {
                    alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô '${group.name}'`);
                    allGroupsValid = false;
                }
            });
            if (!allGroupsValid) return;

            const groupResults = calculationGroups.map(group => {
                const totalQuantity = group.items.reduce((sum, item) => sum + item.quantity, 0);
                const screenInputs = { ...group.screenDetails, quantity: totalQuantity, hasNeckLogo: group.screenDetails.neckLogo };
                const screenPriceResult = calculateScreenPrice(screenInputs);
                
                const totalShirtPrice = group.items.reduce((sum, item) => sum + (item.product.sellPrice * item.quantity), 0);
                const totalScreenPrice = screenPriceResult.screenPricePerItem * totalQuantity;
                const subTotal = totalShirtPrice + totalScreenPrice;
                const averagePricePerItem = totalQuantity > 0 ? subTotal / totalQuantity : 0;

                return { group, totalQuantity, totalShirtPrice, totalScreenPrice, subTotal, averagePricePerItem, screenPriceResult };
            });

            displayGroupedResults(groupResults);
        };

        const displayGroupedResults = (groupResults) => {
            const { resultSummary, grandTotalSummary, resultDetailsContainer, groupedResultContainer } = DOMElements.calculator;
            resultSummary.innerHTML = '';
            resultDetailsContainer.innerHTML = '';
            let grandTotal = 0;

            groupResults.forEach(res => {
                grandTotal += res.subTotal;
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'border-b border-slate-200 pb-4';
                summaryDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-md text-slate-900">${res.group.name} (${res.totalQuantity} ‡∏ï‡∏±‡∏ß)</h4>
                        <button type="button" class="copy-single-group-btn bg-slate-200 text-slate-700 text-xs font-bold py-1 px-3 rounded-md hover:bg-slate-300 transition-colors" data-group-id="${res.group.id}">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                    </div>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between items-baseline"><span class="font-medium">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÄ‡∏™‡∏∑‡πâ‡∏≠:</span><span class="font-semibold text-slate-800">${res.totalShirtPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span></div>
                        <div class="flex justify-between items-baseline"><span class="font-medium">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô:</span><span class="font-semibold text-slate-800">${res.totalScreenPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span></div>
                        <div class="flex justify-between items-baseline mt-1 pt-1 border-t"><span class="font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ:</span><span class="text-lg font-bold text-blue-600">${res.subTotal.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span></div>
                        <div class="flex justify-between items-baseline"><span class="font-medium text-xs">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏±‡∏ß‡∏•‡∏∞:</span><span class="text-sm font-semibold text-slate-900">${res.averagePricePerItem.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span></div>
                    </div>
                `;
                resultSummary.appendChild(summaryDiv);

                const detailsDiv = document.createElement('div');
                detailsDiv.innerHTML = `<p class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î '${res.group.name}':</p>${res.screenPriceResult.details.map(d => `<div>‚Ä¢ ${d}</div>`).join('')}`;
                resultDetailsContainer.appendChild(detailsDiv);
            });

            grandTotalSummary.innerHTML = `<p class="text-3xl font-bold text-blue-700">${grandTotal.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>`;
            groupedResultContainer.classList.remove('hidden');
            groupedResultContainer.scrollIntoView({ behavior: 'smooth' });
        };
        
        const handleScreenOnlyCalculate = (event) => {
            event.preventDefault();
            const formData = new FormData(DOMElements.calculator.screenOnlyForm);
            const inputs = {
                quantity: parseInt(formData.get('quantity')) || 0,
                inkCC: parseInt(formData.get('inkCC')) || 0,
                color: formData.get('color'),
                sides: formData.get('sides'),
                hasNeckLogo: formData.has('neckLogo'),
                sleevePrintCount: parseInt(formData.get('sleevePrintCount')) || 0,
                sideChoice: formData.get('sideChoice'),
                sizeFront: formData.get('sizeFront'),
                sizeBack: formData.get('sizeBack'),
            };

            if (inputs.quantity <= 0 || inputs.inkCC <= 0) {
                return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞ CC ‡∏´‡∏°‡∏∂‡∏Å ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }
            
            const screenPriceResult = calculateScreenPrice(inputs);
            displayScreenOnlyResult(screenPriceResult, inputs.quantity);
        };
        
        const displayScreenOnlyResult = (result, quantity) => {
            const { soResultContainer, soResultSummary, soResultDetails } = DOMElements.calculator;
            const totalScreenPrice = result.screenPricePerItem * quantity;

            soResultSummary.innerHTML = `
                <div class="flex justify-between items-baseline"><span class="font-medium">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß:</span><span class="text-lg font-semibold text-slate-800">${result.screenPricePerItem.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span></div>
                <div class="flex justify-between items-baseline mt-2 pt-2 border-t border-slate-300"><span class="font-bold text-lg">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô (${quantity} ‡∏ï‡∏±‡∏ß):</span><span class="text-2xl font-bold text-blue-600">${totalScreenPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span></div>
            `;
            soResultDetails.innerHTML = `<p class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:</p>${result.details.map(d => `<div>‚Ä¢ ${d}</div>`).join('')}`;
            soResultContainer.classList.remove('hidden');
            soResultContainer.scrollIntoView({ behavior: 'smooth' });
        };

        const handleCopySingleGroup = (groupId, buttonElement) => {
            const group = calculationGroups.find(g => g.id === groupId);
            if (!group) return;

            const totalQuantity = group.items.reduce((sum, item) => sum + item.quantity, 0);
            if (totalQuantity === 0) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ");
                return;
            }
            const screenInputs = { ...group.screenDetails, quantity: totalQuantity, hasNeckLogo: group.screenDetails.neckLogo };
            const screenPriceResult = calculateScreenPrice(screenInputs);
            const totalShirtPrice = group.items.reduce((sum, item) => sum + (item.product.sellPrice * item.quantity), 0);
            const totalScreenPrice = screenPriceResult.screenPricePerItem * totalQuantity;
            const subTotal = totalShirtPrice + totalScreenPrice;

            const textLines = [`‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ DTG - ${group.name}`, `=============================`];
            textLines.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: ${totalQuantity} ‡∏ï‡∏±‡∏ß`);
            if (group.items.length > 0) {
                textLines.push('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏∑‡πâ‡∏≠:');
                group.items.forEach(item => { textLines.push(`  - ${item.product.name} (${item.product.size} - ${item.product.color}) x ${item.quantity}`); });
            }
            let sizeText = (screenInputs.sides === '1') ? (screenInputs.sideChoice === 'front' ? `‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ${screenInputs.sizeFront}` : `‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á ${screenInputs.sizeBack}`) : `‡∏´‡∏ô‡πâ‡∏≤ ${screenInputs.sizeFront}, ‡∏´‡∏•‡∏±‡∏á ${screenInputs.sizeBack}`;
            textLines.push(`‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${sizeText}`);
            let additionalItems = [];
            if (screenInputs.hasNeckLogo) additionalItems.push('‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ñ‡∏≠');
            if (screenInputs.sleevePrintCount > 0) additionalItems.push(`‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÅ‡∏Ç‡∏ô (${screenInputs.sleevePrintCount} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)`);
            if (additionalItems.length > 0) textLines.push(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${additionalItems.join(', ')}`);
            textLines.push(`-----------------------------`);
            textLines.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${screenPriceResult.screenPricePerItem.toFixed(2)} ‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ß`);
            if (screenPriceResult.discountText !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô') { textLines.push(`(‡∏°‡∏µ${screenPriceResult.discountText}‡πÅ‡∏•‡πâ‡∏ß)`); }
            textLines.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÄ‡∏™‡∏∑‡πâ‡∏≠: ${totalShirtPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
            textLines.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${totalScreenPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
            textLines.push(`‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ: ${subTotal.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
            
            navigator.clipboard.writeText(textLines.join('\n')).then(() => {
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                setTimeout(() => { buttonElement.innerHTML = originalText; }, 2000);
            });
        };
        
        const handleCopyGrouped = () => {
            if (DOMElements.calculator.groupedResultContainer.classList.contains('hidden')) {
                return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å");
            }
            const textLines = [`‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ DTG - Anajak T-Shirt`, `=============================`];
            let grandTotal = 0;

            calculationGroups.forEach(group => {
                const totalQuantity = group.items.reduce((sum, item) => sum + item.quantity, 0);
                if (totalQuantity === 0) return;
                const screenInputs = { ...group.screenDetails, quantity: totalQuantity, hasNeckLogo: group.screenDetails.neckLogo };
                const screenPriceResult = calculateScreenPrice(screenInputs);
                const totalShirtPrice = group.items.reduce((sum, item) => sum + (item.product.sellPrice * item.quantity), 0);
                const totalScreenPrice = screenPriceResult.screenPricePerItem * totalQuantity;
                const subTotal = totalShirtPrice + totalScreenPrice;
                grandTotal += subTotal;

                textLines.push(`\n--- ${group.name} ---`);
                textLines.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: ${totalQuantity} ‡∏ï‡∏±‡∏ß`);
                if (group.items.length > 0) {
                    textLines.push('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏∑‡πâ‡∏≠:');
                    group.items.forEach(item => { textLines.push(`  - ${item.product.name} (${item.product.size} - ${item.product.color}) x ${item.quantity}`); });
                }
                let sizeText = (screenInputs.sides === '1') ? (screenInputs.sideChoice === 'front' ? `‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ${screenInputs.sizeFront}` : `‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á ${screenInputs.sizeBack}`) : `‡∏´‡∏ô‡πâ‡∏≤ ${screenInputs.sizeFront}, ‡∏´‡∏•‡∏±‡∏á ${screenInputs.sizeBack}`;
                textLines.push(`‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${sizeText}`);
                let additionalItems = [];
                if (screenInputs.hasNeckLogo) additionalItems.push('‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ñ‡∏≠');
                if (screenInputs.sleevePrintCount > 0) additionalItems.push(`‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÅ‡∏Ç‡∏ô (${screenInputs.sleevePrintCount} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)`);
                if (additionalItems.length > 0) textLines.push(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${additionalItems.join(', ')}`);
                textLines.push(`-----------------------------`);
                textLines.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${screenPriceResult.screenPricePerItem.toFixed(2)} ‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ß`);
                if (screenPriceResult.discountText !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô') { textLines.push(`(‡∏°‡∏µ${screenPriceResult.discountText}‡πÅ‡∏•‡πâ‡∏ß)`); }
                textLines.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÄ‡∏™‡∏∑‡πâ‡∏≠: ${totalShirtPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
                textLines.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${totalScreenPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
                textLines.push(`‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ: ${subTotal.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
            });

            textLines.push(`\n=============================`, `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${grandTotal.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
            
            navigator.clipboard.writeText(textLines.join('\n')).then(() => { 
                const button = DOMElements.calculator.copyGroupedButton;
                const originalText = button.textContent;
                button.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            });
        };

        const handleCopyScreenOnly = () => {
            const resultContainer = DOMElements.calculator.soResultContainer;
            if (resultContainer.classList.contains('hidden')) {
                return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å");
            }
            
            const formData = new FormData(DOMElements.calculator.screenOnlyForm);
            const inputs = {
                quantity: parseInt(formData.get('quantity')) || 0,
                inkCC: parseInt(formData.get('inkCC')) || 0,
                color: formData.get('color'),
                sides: formData.get('sides'),
                sideChoice: formData.get('sideChoice'),
                sizeFront: formData.get('sizeFront'),
                sizeBack: formData.get('sizeBack'),
                hasNeckLogo: formData.has('neckLogo'),
                sleevePrintCount: parseInt(formData.get('sleevePrintCount')) || 0,
            };
            const screenPriceResult = calculateScreenPrice(inputs);
            const totalScreenPrice = screenPriceResult.screenPricePerItem * inputs.quantity;
            
            const textLines = [`‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô)`, `=============================`];
            const colorText = inputs.color === 'white' ? '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß' : '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°/‡∏î‡∏≥';
            textLines.push(`‡∏™‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠: ${colorText}`);
            textLines.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${inputs.quantity} ‡∏ï‡∏±‡∏ß`);
            let sizeText = (inputs.sides === '1') ? (inputs.sideChoice === 'front' ? `‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ${inputs.sizeFront}` : `‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á ${inputs.sizeBack}`) : `‡∏´‡∏ô‡πâ‡∏≤ ${inputs.sizeFront}, ‡∏´‡∏•‡∏±‡∏á ${inputs.sizeBack}`;
            textLines.push(`‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${sizeText}`);
            let additionalItems = [];
            if (inputs.hasNeckLogo) additionalItems.push('‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ñ‡∏≠');
            if (inputs.sleevePrintCount > 0) additionalItems.push(`‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡πÅ‡∏Ç‡∏ô (${inputs.sleevePrintCount} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)`);
            if (additionalItems.length > 0) textLines.push(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${additionalItems.join(', ')}`);
            textLines.push(`-----------------------------`);
            textLines.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß: ${screenPriceResult.screenPricePerItem.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);
            if (screenPriceResult.discountText !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô') { textLines.push(`(‡∏°‡∏µ${screenPriceResult.discountText}‡πÅ‡∏•‡πâ‡∏ß)`); }
            textLines.push(`‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡∏Å‡∏£‡∏µ‡∏ô: ${totalScreenPrice.toFixed(2)} ‡∏ö‡∏≤‡∏ó`);

            navigator.clipboard.writeText(textLines.join('\n')).then(() => { 
                const button = DOMElements.calculator.copyScreenOnlyButton;
                const originalText = button.textContent;
                button.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            });
        };


        // --- UI Logic ---
        const switchTab = (tabId) => {
            DOMElements.contents.forEach(content => content.classList.toggle('active', content.id === tabId));
            DOMElements.tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId));
        };
        
        const switchMode = (mode) => {
            currentMode = mode;
            const { calculator } = DOMElements;
            const isShirtScreen = mode === 'shirt-screen';

            calculator.shirtScreenView.classList.toggle('active', isShirtScreen);
            calculator.screenOnlyView.classList.toggle('active', !isShirtScreen);
            
            calculator.modeShirtScreenBtn.classList.toggle('active', isShirtScreen);
            calculator.modeScreenOnlyBtn.classList.toggle('active', !isShirtScreen);

            // Hide all result containers when switching
            calculator.groupedResultContainer.classList.add('hidden');
            calculator.soResultContainer.classList.add('hidden');
        };

        const updateScreenOnlyFormUI = () => {
            const { soSidesSelect, soSideChoiceContainer, soSizeFrontContainer, soSizeBackContainer } = DOMElements.calculator;
            const sides = soSidesSelect.value;
            const isOneSide = (sides === '1');
            
            soSideChoiceContainer.style.display = isOneSide ? 'block' : 'none';
            if (isOneSide) {
                const sideChoice = document.getElementById('so-sideChoice').value;
                soSizeFrontContainer.style.display = (sideChoice === 'front') ? 'block' : 'none';
                soSizeBackContainer.style.display = (sideChoice === 'back') ? 'block' : 'none';
            } else {
                soSizeFrontContainer.style.display = 'block';
                soSizeBackContainer.style.display = 'block';
            }
        };
        
        // --- Event Delegation ---
        const handleCalculatorTabClick = (e) => {
            const target = e.target;
            const groupId = target.dataset.groupId;

            if (target.matches('.add-item-to-group-btn')) { openProductSelectionModal(groupId); }
            else if (target.matches('.remove-item-btn')) {
                const itemIndex = parseInt(target.dataset.itemIndex);
                const group = calculationGroups.find(g => g.id === groupId);
                if (group) { group.items.splice(itemIndex, 1); renderGroupItems(group); }
            }
            else if (target.matches('.remove-group-btn')) {
                openDeleteModal({ type: 'group', id: groupId, name: target.dataset.groupName });
            }
        };

        const handleCalculatorTabInput = (e) => {
            const target = e.target;
            const groupId = target.dataset.groupId;
            if (!groupId) return;

            if (target.matches('.group-name-input')) { updateGroupState(groupId, 'name', target.value); }
            else if (target.matches('.quantity-input')) {
                const itemIndex = parseInt(target.dataset.itemIndex);
                const quantity = parseInt(target.value) || 1;
                updateGroupState(groupId, 'itemQuantity', { itemIndex, quantity });
            }
            else if (target.matches('.group-input')) {
                const key = target.id.split('-')[0];
                const value = target.type === 'checkbox' ? target.checked : (target.type === 'number' ? parseFloat(target.value) || 0 : target.value);
                updateGroupState(groupId, key, value);
                
                if (target.matches('.group-sides-select, .group-side-choice-select')) {
                    const group = calculationGroups.find(g => g.id === groupId);
                    const groupEl = document.getElementById(groupId);
                    if (group && groupEl) updateGroupFormUI(groupEl, group);
                }
            }
        };
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!app) { DOMElements.adminAccessContainer.innerHTML = '<p class="text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>'; return; };
            
            DOMElements.tabs.forEach(tab => {
                const tabId = tab.dataset.tab;
                if (tabId === 'products-tab' || tabId === 'settings-tab') { tab.addEventListener('click', () => handleProtectedTabClick(tabId)); } 
                else { tab.addEventListener('click', () => switchTab(tabId)); }
            });
            switchTab('calculator-tab'); 

            // --- Calculator Tab ---
            // Mode Switching
            DOMElements.calculator.modeShirtScreenBtn.addEventListener('click', () => switchMode('shirt-screen'));
            DOMElements.calculator.modeScreenOnlyBtn.addEventListener('click', () => switchMode('screen-only'));
            switchMode('screen-only'); // Default mode

            // Grouped Mode
            DOMElements.calculator.addNewGroupBtn.addEventListener('click', addNewCalculationGroup);
            DOMElements.calculator.calculateAllBtn.addEventListener('click', handleShirtAndScreenCalculate);
            DOMElements.calculator.copyGroupedButton.addEventListener('click', handleCopyGrouped);
            DOMElements.calculator.groupsContainer.addEventListener('click', handleCalculatorTabClick);
            DOMElements.calculator.groupsContainer.addEventListener('input', handleCalculatorTabInput);
            DOMElements.calculator.resultSummary.addEventListener('click', (e) => {
                const copyButton = e.target.closest('.copy-single-group-btn');
                if (copyButton) {
                    const groupId = copyButton.dataset.groupId;
                    handleCopySingleGroup(groupId, copyButton);
                }
            });
            renderCalculationGroups();
            
            // Screen-Only Mode
            DOMElements.calculator.screenOnlyForm.addEventListener('submit', handleScreenOnlyCalculate);
            DOMElements.calculator.copyScreenOnlyButton.addEventListener('click', handleCopyScreenOnly);
            DOMElements.calculator.soSidesSelect.addEventListener('change', updateScreenOnlyFormUI);
            document.getElementById('so-sideChoice').addEventListener('change', updateScreenOnlyFormUI);
            updateScreenOnlyFormUI();


            // --- Settings & Products ---
            loadGlobalSettings();
            onSnapshot(collection(db, "products"), (snapshot) => {
                const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductList(products);
            });

            DOMElements.settings.saveButton.addEventListener('click', saveGlobalSettings);
            DOMElements.products.form.addEventListener('submit', handleSaveProduct);
            DOMElements.products.list.addEventListener('click', handleEditProductClick);
            DOMElements.products.importButton.addEventListener('click', () => { if(isAuthorized) DOMElements.products.importInput.click(); else openPasswordModal('products-tab'); });
            DOMElements.products.importInput.addEventListener('change', handleExcelImport);
            DOMElements.products.list.addEventListener('click', (e) => { if(e.target.classList.contains('delete-product-btn')) { if(isAuthorized) openDeleteModal({type: 'product', id: e.target.dataset.id, name: e.target.dataset.name}); else openPasswordModal('products-tab'); } });
            DOMElements.products.cancelButton.addEventListener('click', resetProductForm);

            // --- Modals ---
            DOMElements.deleteModal.cancelButton.addEventListener('click', closeDeleteModal);
            DOMElements.deleteModal.confirmButton.addEventListener('click', () => {
                if (DOMElements.deleteModal.deleteType === 'product') {
                    handleDeleteProduct(DOMElements.deleteModal.itemIdToDelete);
                } else if (DOMElements.deleteModal.deleteType === 'group') {
                    calculationGroups = calculationGroups.filter(g => g.id !== DOMElements.deleteModal.itemIdToDelete);
                    renderCalculationGroups();
                }
                closeDeleteModal();
            });
            
            DOMElements.passwordModal.cancelButton.addEventListener('click', closePasswordModal);
            DOMElements.passwordModal.submitButton.addEventListener('click', handlePasswordSubmit);
            DOMElements.passwordModal.input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handlePasswordSubmit(); });

            // Product Selection Modal Listeners
            DOMElements.productSelectionModal.backdrop.addEventListener('click', (e) => { if (e.target === DOMElements.productSelectionModal.backdrop) closeProductSelectionModal(); });
            DOMElements.productSelectionModal.nameList.addEventListener('click', handleProductSelection);
            DOMElements.productSelectionModal.sizeList.addEventListener('click', handleProductSelection);
            DOMElements.productSelectionModal.colorList.addEventListener('click', handleProductSelection);
            DOMElements.productSelectionModal.cancelBtn.addEventListener('click', closeProductSelectionModal);
            DOMElements.productSelectionModal.backToStep1Btn.addEventListener('click', (e) => { e.stopPropagation(); populateSelectionStep1(); });
            DOMElements.productSelectionModal.backToStep2Btn.addEventListener('click', (e) => { e.stopPropagation(); populateSelectionStep2(); });
            DOMElements.productSelectionModal.confirmAddBtn.addEventListener('click', addItemToCalculationGroup);
        });
    </script>
</body>
</html>
